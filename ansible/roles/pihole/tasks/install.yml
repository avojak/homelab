---
- name: Ensure container is running
  docker_container:
    name: pihole
    image: pihole/pihole:latest
    state: started
    restart: no
    restart_policy: unless-stopped
    pull: yes
    ports:
      - '{{ ansible_host }}:53:53/udp'
      - '{{ ansible_host }}:53:53/tcp'
      - '80:80/tcp'
      - '443:443/tcp'
    volumes:
      - /opt/pihole/etc-pihole/:/etc/pihole/
      - /opt/pihole/etc-dnsmasq.d:/etc/dnsmasq.d/
    hostname: "{{ inventory_hostname }}"
    env:
      TZ: "{{ pihole_timezone }}"
      WEBPASSWORD: "{{ pihole_web_password }}"
      PIHOLE_DNS_: "{{ pihole_upstream_dns | join(';') }}"
      TEMPERATUREUNIT: "{{ pihole_temp_unit }}"
      DNSMASQ_LISTENING: "{{ pihole_dnsmasq }}"
      FTLCONF_LOCAL_IPV4: "127.0.0.1"
      DNS_FQDN_REQUIRED: "true"
      DNSSEC: "false"
      VIRTUAL_HOST: "{{ inventory_hostname }}"

- name: Wait for container to be ready
  uri:
    url: http://localhost
  register: container_result
  until: container_result.status == 200
  retries: 10
  delay: 10

# Install adlists and domainlist
- include_tasks: install-adlists.yml
- include_tasks: install-domainlist.yml

- name: Cleanup stale Docker images
  docker_prune:
    images: yes
    images_filters:
      dangling: false

- name: Ensure ports open on the firewall
  ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
  loop:
    - { port: 53, proto: "udp" } # DNS
    - { port: 53, proto: "tcp" } # DNS
    - { port: 80, proto: "tcp" } # HTTP dashboard
    - { port: 443, proto: "tcp" } # HTTPS dashboard
